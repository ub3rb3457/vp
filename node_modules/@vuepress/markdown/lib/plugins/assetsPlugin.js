"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.assetsPlugin = void 0;
const mdurl_1 = require("mdurl");
const utils_1 = require("@vuepress/utils");
/**
 * Plugin to handle assets links
 */
const assetsPlugin = (md, { relativePathPrefix = '@source' } = {}) => {
    const rawRule = md.renderer.rules.image;
    md.renderer.rules.image = (tokens, idx, options, env, self) => {
        const token = tokens[idx];
        // get the image link
        const link = token.attrGet('src');
        if (!link) {
            return rawRule(tokens, idx, options, env, self);
        }
        // decode link to ensure bundler can find the file correctly
        let resolvedLink = mdurl_1.decode(link);
        // if the link is relative path, and the `env.filePathRelative` exists
        // add `@source` alias to the link
        if (/^\.{1,2}\//.test(link) && env.filePathRelative) {
            resolvedLink = `${relativePathPrefix}/${utils_1.path.join(utils_1.path.dirname(env.filePathRelative), resolvedLink)}`;
        }
        // replace the original link with resolved link
        token.attrSet('src', resolvedLink);
        return rawRule(tokens, idx, options, env, self);
    };
};
exports.assetsPlugin = assetsPlugin;
